# Установка и базовая настройка

## Системные настройки

| Название                       | Значение по умолчанию  | Описание                                                                            |
| ------------------------------ | ---------------------- | ----------------------------------------------------------------------------------- |
| **amocrm_account**             |                        | Аккаунт. Поддомен домена amocrm.ru                                                  |
| **amocrm_hash**                |                        | Ключ пользователя, можно получить на странице редактирования профиля пользователя   |
| **amocrm_login**               |                        | Логин, с которым вы авторизуетесь в amoCRM                                          |
| **amocrm_secret_key**          |                        | Секретный ключ виджета                                                              |

Пример заполнения настроек показан ниже:

[![](https://file.modx.pro/files/6/9/a/69ad3bcb28fd3789a0398d75503fed2as.jpg)](https://file.modx.pro/files/6/9/a/69ad3bcb28fd3789a0398d75503fed2a.png)


## Как получить значение amocrm_hash

Откройте профиль пользователя, ключ указан в секции "Ваш API"  
 
[![](https://file.modx.pro/files/1/f/c/1fcef3724ca4a1bb876199c76f040b22s.jpg)](https://file.modx.pro/files/1/f/c/1fcef3724ca4a1bb876199c76f040b22.png)


## Как получить значение amocrm_secret_key

Ввод значения секретного ключа необходим только для создания дополнительных полей с помощью модуля. Если Вы планируете создавать поля самостоятельно, ключ вводить не требуется.

Перейдите в раздел API настроек **amoCRM** (*https://YOUR_DOMAIN.amocrm.ru/settings/dev/*) и добавьте новый виджет, если не создан ранее.  

[![](https://file.modx.pro/files/b/7/e/b7e530d936c3853d26517007528fc12ds.jpg)](https://file.modx.pro/files/b/7/e/b7e530d936c3853d26517007528fc12d.png) 
 
В окне ввода кода виджета можно ввести что-то осмысленное, но самое главное, чтобы код оказался уникальным в рамках всего **amoCRM**.

Затем в таблице виджетов скопируйте значение из колонки *"Секретный ключ"* и введите в системную настройку.  
**Важно:** выделять ключ необходимо двойным кликом, так как он очень длинный и не помещается в отображаемой визуальной части полностью.

[![](https://file.modx.pro/files/f/1/c/f1c68cc16e1e1f596c1306b123cf56fas.jpg)](https://file.modx.pro/files/f/1/c/f1c68cc16e1e1f596c1306b123cf56fa.png)




# Системные настройки
## Основные
| Название                       | Значение по умолчанию  | Описание                                                                            |
| ------------------------------ | ---------------------- | ----------------------------------------------------------------------------------- |
| **amocrm_use_simple_queue**    | Нет                    | Включить использование очередей [simpleQueue][1]                                    |
| **amocrm_form_as_lead**        | Нет                    | Создавать сделки из данных форм                                                     |
| **amocrm_save_user_in_mgr**    | Нет                    | Включить создание/обновление контактов при сохранении пользователя в админке сайта  |
| **amocrm_save_user_by_profile**| Нет                    | Включить создание/обновление контактов при сохранении профиля пользователя          |

### Пояснения
* **amocrm_use_simple_queue**
 Если включена данная настройка и установлен компонент [simpleQueue][1], вместо отправки данных в реальном времени будет создано задание на отправку и помещено в очередь.
 Для отправки необходимо настроить запуск скрипта _core/components/amocrm/cron/secondlyrunner.php_ ежеминутно.  
 **Пример** записи в планировщике _cron_ на хостинге [MODHOST][2]:
`* * * * * php ~/www/core/components/amocrm/cron/secondlyrunner.php`

* **amocrm_save_user_by_profile**  
 При включении данной настройки отправка данных в amoCRM будет происходить при вызове события _OnUserProfileSave_ при сохранении профиля _$profile_save()_.  
 Поскольку при использовани процессоров или сохранении в админке передача данных происходит на событии _OnUserFormSave_,
 в большинстве случаев включение данной настройки не требуется. Если же ее включить, во многих случаях при одном сохранении пользователя отправка данных может осуществляться дважды. 
  
  Не рекомендуется включать, если нет осознанной необходимости 

## Воронки и статусы

| Название                       | Значение по умолчанию  | Описание                                                                            |
| ------------------------------ | ---------------------- | ----------------------------------------------------------------------------------- |
| **amocrm_new_order_status_id** | 1                      | ID статуса нового заказа minishop2                                                  |
| **amocrm_pipeline_id**         |                        | ID воронки для новой сделка из заказа. Заполняется автоматически при первом заказе  |
| **amocrm_form_pipeline_id**    |                        | ID воронки для новой сделки из формы, заполняется автоматически при первом создании сделки |
| **amocrm_form_status_new**     |                        | ID статуса для новой сделки из формы. Статус должен существовать в воронке, указанной в настройке _amocrm_form_pipeline_id_ |
| **amocrm_auto_update_pipelines**| Нет                   | Автоматически обновлять воронки и статусы для сделок из заказов                    |


## Поля контактов и сделок

| Название                       | Значение по умолчанию  | Описание                                                                                                           |
| ------------------------------ | ---------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **amocrm_form_filled_fields**  |                        | Список обязательно заполненных полей для форм. Если какое-либо поле не заполнено, сделка не будет создана          |
| **amocrm_order_fields**        | weight,delivery_cost,goods                       | Список полей заказа, передаваемых при создании сделки. Список товаров сохраняется в полей _goods_ |
| **amocrm_order_address_fields**| phone,city,street,building,room,comment          | ID воронки для нового заказа, заполняется автоматически при первом заказе                |
| **amocrm_categories_pipelines**| {}                     | Массив для указания особых параметров для воронки, статуса, ответственного на основании категорий товаров в заказе |
| **amocrm_responsible_id_priority_category** | Да        | Включить принудительное применение ответственного и воронки, найденные по категории товаров в заказе               |
| **amocrm_order_properties_element**    | amoCRMFields   | Название массива в свойствах заказа (_properties_), элементы которого заменят значения по умолчанию                |
| **amocrm_user_fields**         |                        | Список полей пользователя, передаваемых при создании/обновлении контакта            |
| **amocrm_user_enum_fields**    | {"phone":"WORK","email":"WORK","телефон":"WORK"} | JSON массив с указанием ENUM полей и их типов             |
| **amocrm_user_readonly_fields**| name                   | Список полей контактов, защищенных от изменения при передаче данных с сайта         |
| **amocrm_skip_empty_fields**   | Да                     | Пропускать поля с пустыми значениями при подготовке данных для передачи в amoCRM    |
| **amocrm_default_responsible_user_id** |                | ID пользователя, назначаемого ответственным по умолчанию. Не совпадает с ID пользователя MODX и ID какого-либо контакта     |
| **amocrm_auto_create_orders_fields**   | Да             | Автоматически создавать отсутствующие в amoCRM поля для сделок (не работает на базовом тарифе)                     |
| **amocrm_auto_create_users_fields**    | Да             | Автоматически создавать отсутствующие в amoCRM поля для контактов (не работает на базовом тарифе)                  |

### Пояснения

* **amocrm_categories_pipelines**  
 JSON-массив для указания ответственного, воронки и статуса на основании категорий товаров, входящих в заказ.  
 **Формат:**  
  ```
    {  
      "40": 
        {  
            "pipeline_id":23456,  
            "status_id":567890,  
            "responsible_user_id": 123453  
        },  
      "39":
        {  
            "pipeline_id":34567,  
            "status_id":87654  
        }  
    }  
  ```
 Поиск происходит по родительским категориям товаров до первого совпадения. Если в заказе есть несколько товаров, для категорий которых указаны особые параметры, использованы будут параметры для первой обнаруженной категории.   

* **amocrm_responsible_id_priority_category**  
 Если настройка включена, то при передаче данных ID ответственного, сохраненного в свойствах заказа, заменяется на ID ответственного, найденного по категориям товаров.   
 Если выключена, указанный в свойствах заказа ответственный будет сохранен.


[1]: https://modstore.pro/packages/utilities/simplequeue
[2]: https://modhost.pro/?msfrom=e0acf53794eabbc780f2a48bea8ec423